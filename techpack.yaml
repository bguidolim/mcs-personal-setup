schemaVersion: 1
identifier: bruno-setup
displayName: "Bruno's Personal Setup"
description: Combined Core + iOS development environment for Claude Code
version: "1.0.0"
minMCSVersion: "2.1.0"

# ---------------------------------------------------------------------------
# Prompts — resolved interactively during `mcs configure`
# ---------------------------------------------------------------------------
prompts:
  - key: PROJECT
    type: fileDetect
    label: "Xcode project / workspace"
    detectPattern: "*.xcodeproj"

# ---------------------------------------------------------------------------
# Components (short IDs — auto-prefixed by engine with `bruno-setup.`)
# ---------------------------------------------------------------------------
components:
  # ── Dependencies ────────────────────────────────────────────────────────
  - id: homebrew
    displayName: Homebrew
    description: macOS package manager
    type: brewPackage
    installAction:
      type: shellCommand
      command: '/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"'
    doctorChecks:
      - type: commandExists
        name: Homebrew
        section: Dependencies
        command: brew

  - id: node
    displayName: Node.js
    description: JavaScript runtime (for npx-based MCP servers)
    type: brewPackage
    dependencies: [homebrew]
    installAction:
      type: brewInstall
      package: node

  - id: gh
    displayName: GitHub CLI
    description: GitHub CLI for PR operations
    type: brewPackage
    dependencies: [homebrew]
    installAction:
      type: brewInstall
      package: gh

  - id: jq
    displayName: jq
    description: JSON processor (used by session hooks)
    type: brewPackage
    dependencies: [homebrew]
    installAction:
      type: brewInstall
      package: jq

  - id: ollama
    displayName: Ollama
    description: Local LLM runtime with nomic-embed-text model
    type: brewPackage
    dependencies: [homebrew]
    installAction:
      type: brewInstall
      package: ollama

  - id: uv
    displayName: uv
    description: Python package runner (for Serena MCP server)
    type: brewPackage
    dependencies: [homebrew]
    installAction:
      type: brewInstall
      package: uv

  - id: claude-code
    displayName: Claude Code
    description: Claude Code CLI
    type: brewPackage
    dependencies: [homebrew]
    installAction:
      type: shellCommand
      command: "brew install --cask claude-code"
    doctorChecks:
      - type: commandExists
        name: Claude Code
        section: Dependencies
        command: claude

  # ── MCP Servers ─────────────────────────────────────────────────────────
  - id: docs-mcp-server
    displayName: docs-mcp-server
    description: Semantic search over memories using local Ollama embeddings
    type: mcpServer
    dependencies: [node, ollama]
    installAction:
      type: mcpServer
      name: docs-mcp-server
      command: npx
      args:
        - "-y"
        - "@arabold/docs-mcp-server@latest"
        - "--read-only"
        - "--telemetry=false"
      env:
        OPENAI_API_KEY: "ollama"
        OPENAI_API_BASE: "http://localhost:11434/v1"
        DOCS_MCP_EMBEDDING_MODEL: "openai:nomic-embed-text"

  - id: serena
    displayName: Serena
    description: Semantic code navigation, symbol editing, and project context via LSP
    type: mcpServer
    dependencies: [uv]
    installAction:
      type: mcpServer
      name: serena
      command: uvx
      args:
        - "--from"
        - "git+https://github.com/oraios/serena"
        - "serena"
        - "start-mcp-server"
        - "--context=claude-code"
        - "--project-from-cwd"

  - id: xcodebuildmcp
    displayName: XcodeBuildMCP
    description: MCP server for Xcode build, test, and simulator workflows
    type: mcpServer
    dependencies: [node]
    installAction:
      type: mcpServer
      name: XcodeBuildMCP
      command: npx
      args:
        - "-y"
        - "xcodebuildmcp@latest"
        - "mcp"
      env:
        XCODEBUILDMCP_SENTRY_DISABLED: "1"

  - id: sosumi
    displayName: Sosumi
    description: Apple documentation search via MCP (HTTP transport)
    type: mcpServer
    installAction:
      type: mcpServer
      name: sosumi
      transport: http
      url: https://sosumi.ai/mcp

  # ── Plugins ─────────────────────────────────────────────────────────────
  - id: plugin-explanatory-output
    displayName: explanatory-output-style
    description: Enhanced output with educational insights and structured formatting
    type: plugin
    installAction:
      type: plugin
      name: "explanatory-output-style@claude-plugins-official"

  - id: plugin-pr-review
    displayName: pr-review-toolkit
    description: Specialized PR review agents
    type: plugin
    installAction:
      type: plugin
      name: "pr-review-toolkit@claude-plugins-official"

  - id: plugin-ralph-loop
    displayName: ralph-loop
    description: Iterative refinement loop for complex multi-step tasks
    type: plugin
    installAction:
      type: plugin
      name: "ralph-loop@claude-plugins-official"

  - id: plugin-claude-md
    displayName: claude-md-management
    description: Audit and improve CLAUDE.md files across repositories
    type: plugin
    installAction:
      type: plugin
      name: "claude-md-management@claude-plugins-official"

  # ── Skills ──────────────────────────────────────────────────────────────
  - id: skill-continuous-learning
    displayName: continuous-learning skill
    description: Extracts learnings and decisions from sessions into memory
    type: skill
    installAction:
      type: copyPackFile
      source: skills/continuous-learning
      destination: continuous-learning
      fileType: skill

  - id: skill-xcodebuildmcp
    displayName: xcodebuildmcp skill
    description: Loads XcodeBuildMCP tool catalog and workflow guidance
    type: skill
    dependencies: [xcodebuildmcp]
    installAction:
      type: shellCommand
      command: "npx -y skills add cameroncooke/xcodebuildmcp -g -a claude-code -y"

  # ── Hooks ───────────────────────────────────────────────────────────────
  - id: hook-session-start
    displayName: Session start hook
    description: Shows git status, branch protection, and open PRs on session start
    type: hookFile
    dependencies: [jq]
    isRequired: true
    installAction:
      type: copyPackFile
      source: hooks/session_start.sh
      destination: session_start.sh
      fileType: hook

  - id: hook-continuous-learning
    displayName: Continuous learning activator
    description: Reminds to evaluate learnings on each prompt
    type: hookFile
    installAction:
      type: copyPackFile
      source: hooks/continuous-learning-activator.sh
      destination: continuous-learning-activator.sh
      fileType: hook

  - id: hook-ollama-status
    displayName: Ollama status hook
    description: Checks Ollama health and syncs docs-mcp-server library on session start
    type: hookFile
    dependencies: [ollama, docs-mcp-server]
    installAction:
      type: copyPackFile
      source: hooks/ollama-status.sh
      destination: ollama-status.sh
      fileType: hook

  - id: hook-ios-simulator
    displayName: iOS simulator status hook
    description: Reports booted iOS simulator UUID on session start
    type: hookFile
    dependencies: [jq]
    installAction:
      type: copyPackFile
      source: hooks/ios-simulator-status.sh
      destination: ios-simulator-status.sh
      fileType: hook

  # ── Commands ────────────────────────────────────────────────────────────
  - id: command-pr
    displayName: /pr command
    description: Automates stage, commit, push, and PR creation with ticket extraction
    type: command
    dependencies: [gh]
    installAction:
      type: copyPackFile
      source: commands/pr.md
      destination: pr.md
      fileType: command

  - id: command-commit
    displayName: /commit command
    description: Stages, commits, and pushes changes without PR creation
    type: command
    installAction:
      type: copyPackFile
      source: commands/commit.md
      destination: commit.md
      fileType: command

  # ── Configuration ───────────────────────────────────────────────────────
  - id: settings
    displayName: Settings
    description: Plan mode, always-thinking, env vars, hooks config, plugins
    type: configuration
    isRequired: true
    installAction:
      type: settingsFile
      source: config/settings.json

  - id: gitignore
    displayName: Global gitignore
    description: Core and iOS gitignore entries
    type: configuration
    isRequired: true
    installAction:
      type: gitignoreEntries
      entries:
        - .claude/memories
        - .claude/settings.local.json
        - .claude/.mcs-project
        - .xcodebuildmcp

# ---------------------------------------------------------------------------
# Templates — CLAUDE.local.md sections
# ---------------------------------------------------------------------------
templates:
  - sectionIdentifier: bruno-setup.continuous-learning
    placeholders:
      - __REPO_NAME__
    contentFile: templates/continuous-learning.md

  - sectionIdentifier: bruno-setup.serena
    contentFile: templates/serena.md

  - sectionIdentifier: bruno-setup.ios
    placeholders:
      - __PROJECT__
    contentFile: templates/ios.md

# ---------------------------------------------------------------------------
# Configure project script — runs during `mcs configure`
# ---------------------------------------------------------------------------
configureProject:
  script: scripts/configure-xcode.sh

# ---------------------------------------------------------------------------
# Supplementary doctor checks
# ---------------------------------------------------------------------------
supplementaryDoctorChecks:
  - type: shellScript
    name: Xcode Command Line Tools
    section: iOS
    command: "xcode-select -p >/dev/null 2>&1"
    fixCommand: "xcode-select --install"

  - type: hookEventExists
    name: SessionStart hook
    section: Hooks
    event: SessionStart

  - type: settingsKeyEquals
    name: Plan mode enabled
    section: Settings
    keyPath: permissions.defaultMode
    expectedValue: plan
